<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | VX Games 1.1</title>
    <!-- <link rel="shortcut icon" href="TemplateData/favicon.ico"> -->
    <!-- <link rel="stylesheet" href="TemplateData/style.css"> -->
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width=1024 height=768></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"> </div>
        <div id="unity-footer">
            <div id="unity-webgl-logo"></div>
            <div id="unity-fullscreen-button"></div>
            <div id="unity-build-title">VX Games 1.1</div>
        </div>
    </div>

    <!-- RONIN DEBUG PANEL -->
    <div id="ronin-debug" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.9); color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 11px; max-width: 300px; z-index: 9999;">
        <div style="color: #ffff00; font-weight: bold; margin-bottom: 10px;">üîç RONIN DEBUG CONSOLE</div>
        <div id="ronin-status">üîç Initializing...</div>
        <div id="ronin-logs" style="max-height: 200px; overflow-y: auto; margin-top: 10px; border-top: 1px solid #333; padding-top: 10px;">
            <div style="color: #888;">Debug logs will appear here...</div>
        </div>
        <button onclick="clearDebugLogs()" style="margin-top: 10px; padding: 5px; background: #333; color: white; border: none; border-radius: 3px; cursor: pointer;">Clear Logs</button>
    </div>

    <script>
        // ENHANCED DEBUG LOGGING SYSTEM
        let debugLogs = [];
        let roninDetected = false;
        let roninConnected = false;
        let currentAddress = "";

        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#00ff00',
                'warning': '#ffff00', 
                'error': '#ff6b6b',
                'success': '#51cf66'
            };
            
            console.log(`[${timestamp}] [Ronin] ${message}`);
            
            debugLogs.push({
                time: timestamp,
                message: message,
                type: type
            });
            
            // Update debug panel
            const statusEl = document.getElementById('ronin-status');
            const logsEl = document.getElementById('ronin-logs');
            
            if (statusEl) {
                statusEl.innerHTML = `<span style="color: ${colors[type]}">${message}</span>`;
            }
            
            if (logsEl && debugLogs.length > 0) {
                logsEl.innerHTML = debugLogs.slice(-10).map(log => 
                    `<div style="color: ${colors[log.type]}; margin: 2px 0;">[${log.time}] ${log.message}</div>`
                ).join('');
                logsEl.scrollTop = logsEl.scrollHeight;
            }
        }

        function clearDebugLogs() {
            debugLogs = [];
            document.getElementById('ronin-logs').innerHTML = '<div style="color: #888;">Debug logs cleared...</div>';
        }

        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingBar = document.querySelector("#unity-loading-bar");
        var progressBarFull = document.querySelector("#unity-progress-bar-full");
        var fullscreenButton = document.querySelector("#unity-fullscreen-button");
        var warningBanner = document.querySelector("#unity-warning");

        function unityShowBanner(msg, type) {
            function updateBannerVisibility() {
                warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
            }
            var div = document.createElement('div');
            div.innerHTML = msg;
            warningBanner.appendChild(div);
            if (type == 'error') div.style = 'background: red; padding: 10px;';
            else {
                if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
                setTimeout(function() {
                    warningBanner.removeChild(div);
                    updateBannerVisibility();
                }, 5000);
            }
            updateBannerVisibility();
        }

        var buildUrl = "Build";
        var loaderUrl = buildUrl + "/VXGamesWebGL.loader.js";
        var config = {
            dataUrl: buildUrl + "/VXGamesWebGL.data",
            frameworkUrl: buildUrl + "/VXGamesWebGL.framework.js",
            codeUrl: buildUrl + "/VXGamesWebGL.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "VXG Inc.",
            productName: "VX Games 1.1",
            productVersion: "0.1.0",
            showBanner: unityShowBanner
        };

        debugLog("üöÄ Starting Unity WebGL build...", 'info');
        debugLog(`üì¶ Build URL: ${buildUrl}`, 'info');
        debugLog(`üéÆ Product: ${config.productName}`, 'info');

        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            var meta = document.createElement('meta');
            meta.name = 'viewport';
            meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
            document.getElementsByTagName('head')[0].appendChild(meta);
            container.className = "unity-mobile";
            canvas.className = "unity-mobile";
            config.devicePixelRatio = 1;
            debugLog("üì± Mobile device detected", 'warning');
            unityShowBanner('WebGL builds are not supported on mobile devices.');
        } else {
            canvas.style.width = "1024px";
            canvas.style.height = "768px";
            debugLog("üñ•Ô∏è Desktop device detected", 'info');
        }

        loadingBar.style.display = "block";

        // EARLY RONIN DETECTION
        setTimeout(function() {
            debugLog("üîç Starting early Ronin detection...", 'info');
            if (typeof window.ronin !== 'undefined') {
                debugLog("‚úÖ window.ronin object found!", 'success');
                if (window.ronin.provider) {
                    debugLog("‚úÖ window.ronin.provider found!", 'success');
                    roninDetected = true;
                } else {
                    debugLog("‚ùå window.ronin.provider not found", 'error');
                }
            } else {
                debugLog("‚ùå window.ronin not found", 'error');
            }

            if (typeof window.ethereum !== 'undefined') {
                debugLog("üîç window.ethereum found, checking if Ronin...", 'info');
                if (window.ethereum.isRonin) {
                    debugLog("‚úÖ window.ethereum.isRonin = true", 'success');
                    roninDetected = true;
                } else {
                    debugLog("‚ùå window.ethereum.isRonin = false", 'warning');
                }
            } else {
                debugLog("‚ùå window.ethereum not found", 'error');
            }

            debugLog(`üéØ Final detection result: ${roninDetected ? 'DETECTED' : 'NOT DETECTED'}`, roninDetected ? 'success' : 'error');
        }, 500);

        var script = document.createElement("script");
        script.src = buildUrl + "/VXGamesWebGL.loader.js";
        script.onload = function() {
            debugLog("üìú Unity loader script loaded successfully", 'success');
            
            createUnityInstance(canvas, config, function(progress) {
                progressBarFull.style.width = 100 * progress + "%";
                if (progress < 1) {
                    debugLog(`‚è≥ Unity loading progress: ${Math.round(progress * 100)}%`, 'info');
                }
            }).then(function(unityInstance) {
                loadingBar.style.display = "none";
                debugLog("üéâ Unity instance created successfully!", 'success');
                
                fullscreenButton.onclick = function() {
                    document.makeFullscreen('unity-container');
                };

                // === ENHANCED RONIN WALLET FUNCTIONS WITH FULL DEBUG ===
                window.unityGame = unityInstance;
                debugLog("üîó Unity game instance stored globally", 'info');
                
                window.DetectRoninWallet = function() {
                    debugLog("üîç DetectRoninWallet() called from Unity", 'info');
                    
                    // Re-check detection
                    let detected = false;
                    if (typeof window.ronin !== 'undefined' && window.ronin.provider) {
                        detected = true;
                        debugLog("‚úÖ Ronin provider confirmed available", 'success');
                    } else if (typeof window.ethereum !== 'undefined' && window.ethereum.isRonin) {
                        detected = true;
                        debugLog("‚úÖ Ronin via ethereum provider confirmed", 'success');
                    } else {
                        debugLog("‚ùå No Ronin provider found", 'error');
                    }
                    
                    debugLog(`üéØ DetectRoninWallet returning: ${detected}`, detected ? 'success' : 'error');
                    return detected;
                };
                
                window.ConnectRoninWallet = function() {
                    debugLog("üöÄ ConnectRoninWallet() called from Unity", 'info');
                    
                    const provider = window.ronin?.provider || (window.ethereum?.isRonin ? window.ethereum : null);
                    
                    if (!provider) {
                        const error = "No Ronin provider available";
                        debugLog(`‚ùå ${error}`, 'error');
                        unityInstance.SendMessage('RoninJSBridge', 'OnWalletConnectionFailed', error);
                        return;
                    }
                    
                    debugLog("üîó Ronin provider found, requesting accounts...", 'info');
                    
                    provider.request({method: 'eth_requestAccounts'})
                        .then(function(accounts) {
                            debugLog(`üìã Received ${accounts.length} accounts from provider`, 'info');
                            
                            if (accounts.length > 0) {
                                currentAddress = accounts[0];
                                roninConnected = true;
                                debugLog(`‚úÖ Connected to address: ${currentAddress}`, 'success');
                                debugLog("üì§ Sending success message to Unity...", 'info');
                                unityInstance.SendMessage('RoninJSBridge', 'OnWalletConnectionSuccess', currentAddress);
                            } else {
                                const error = "No accounts returned from provider";
                                debugLog(`‚ùå ${error}`, 'error');
                                unityInstance.SendMessage('RoninJSBridge', 'OnWalletConnectionFailed', error);
                            }
                        })
                        .catch(function(error) {
                            debugLog(`‚ùå Provider request failed: ${error.message}`, 'error');
                            debugLog(`‚ùå Error code: ${error.code}`, 'error');
                            
                            let errorMessage = "Connection failed";
                            if (error.code === 4001) {
                                errorMessage = "User rejected the connection";
                                debugLog("üö´ User rejected connection request", 'warning');
                                unityInstance.SendMessage('RoninJSBridge', 'OnWalletConnectionRejected');
                            } else {
                                unityInstance.SendMessage('RoninJSBridge', 'OnWalletConnectionFailed', error.message);
                            }
                        });
                };
                
                window.GetRoninAddress = function() {
                    debugLog(`üìç GetRoninAddress() called, returning: ${currentAddress}`, 'info');
                    return currentAddress;
                };
                
                window.IsRoninConnected = function() {
                    const connected = roninConnected && currentAddress !== "";
                    debugLog(`üîó IsRoninConnected() called, returning: ${connected}`, 'info');
                    return connected;
                };

                // Test Unity communication
                debugLog("üß™ Testing Unity communication...", 'info');
                setTimeout(function() {
                    if (window.unityGame) {
                        debugLog("‚úÖ Unity game reference confirmed working", 'success');
                    } else {
                        debugLog("‚ùå Unity game reference lost!", 'error');
                    }
                }, 1000);

                debugLog("üéØ All Ronin functions registered successfully", 'success');

            }).catch(function(message) {
                debugLog(`üí• Unity instance creation failed: ${message}`, 'error');
                alert(message);
            });
        };

        script.onerror = function() {
            debugLog("üí• Failed to load Unity loader script", 'error');
        };

        debugLog("üìú Adding Unity loader script to page...", 'info');
        document.body.appendChild(script);
    </script>
</body>
</html>
